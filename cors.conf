# $cors_enabled - "true" or "false" (required)
# $cors_allow_origin — string (optional)
# $cors_allow_methods — string separated by comma (optional)
# $cors_allow_headers — string separated by comma (optional)
# $cors_allow_credentials — "true" or "false" (optional)
# $cors_allow_expose_headers — string (optional)
# $cors_vary — string or "false" (optional)
# $cors_max_age — number (optional)
# $cors_debug - "true" or "false" (optional)

set $cors_flags '0';
set $cors_allowed 'true';
set $cors_vary_default 'Origin';
set $cors_allow_methods_default 'OPTIONS, GET, POST';
set $cors_allow_headers_default 'Origin, X-Requested-With, X-Request-Id';
set $cors_allow_expose_headers_default '';

# Supproted?
if ($cors_supported = '') {
	set $cors_supported 'false';
}

# Default: enabled
if ($cors_enabled = '') {
	set $cors_enabled 'false';
}

# Default: origin
if ($cors_allow_origin = '') {
	set $cors_allow_origin $http_origin;
}

# Default: methods
if ($cors_allow_methods = '') {
	set $cors_allow_methods $cors_allow_methods_default;
}

# Default: header
if ($cors_allow_headers = '') {
	set $cors_allow_headers $cors_allow_headers_default;
}

# Default: credentials
if ($cors_allow_credentials = '') {
	set $cors_allow_credentials 'false';
}

# Default: expose headers
if ($cors_allow_expose_headers = '') {
	set $cors_allow_expose_headers $cors_allow_expose_headers_default;
}

# Default: vary
if ($cors_vary = '') {
	set $cors_vary $cors_vary_default;
}

# Default: max age
if ($cors_max_age = '') {
	set $cors_max_age '86400';
}

# Check: Vary
if ($cors_vary = 'false') {
	set $cors_vary '';
}

# Check: origin
if ($cors_enabled = 'true') {
	set $cors_flags '1';
}

# Check: method
if ($request_method = 'OPTIONS') {
	set $cors_flags "${cors_flags}2";
}

if ($cors_allow_credentials = 'true') {
	set $cors_flags "${cors_flags}3";
}

# Allowed?
if ($cors_flags = '0') {
	set $cors_allowed 'false';
}

# Default: debug
if ($cors_debug = '') {
	set $cors_debug 'false';
}

# debug
if ($cors_debug = 'true') {
	add_header X-CORS-Debug-Supported $cors_supported;
	add_header X-CORS-Debug-Enabled $cors_enabled;
	add_header X-CORS-Debug-Flags $cors_flags;
	add_header X-CORS-Debug-Allowed $cors_allowed;
	add_header X-CORS-Debug-Http-Origin $http_origin;
	add_header X-CORS-Debug-Url "$scheme://$host$request_uri";
	add_header X-CORS-Debug-Request-Method $request_method;

	add_header X-CORS-Debug-Access-Control-Allow-Origin $cors_allow_origin;
	add_header X-CORS-Debug-Access-Control-Allow-Methods $cors_allow_methods;
	add_header X-CORS-Debug-Access-Control-Allow-Headers $cors_allow_headers;
	add_header X-CORS-Debug-Access-Control-Allow-Credentials $cors_allow_credentials;
	add_header X-CORS-Debug-Access-Control-Expose-Headers $cors_allow_expose_headers;
	add_header X-CORS-Debug-Access-Control-Max-Age $cors_max_age;
	add_header X-CORS-Debug-Vary $cors_vary;
	return 204;
}

# NOT OPTIONS: without credentials
if ($cors_flags = '1') {
	add_header Access-Control-Allow-Origin $cors_allow_origin;
	add_header Vary $cors_vary always;
}

# NOT OPTIONS: with credentials
if ($cors_flags = '13') {
	add_header Access-Control-Allow-Origin $http_origin;
	add_header Access-Control-Allow-Credentials 'true';
	add_header Vary $cors_vary always;
}

# OPTIONS: without credentials
if ($cors_flags = '12') {
	add_header Access-Control-Allow-Origin $cors_allow_origin;
	add_header Access-Control-Allow-Methods $cors_allow_methods;
	add_header Access-Control-Allow-Headers $cors_allow_headers;
	add_header Access-Control-Expose-Headers $cors_allow_expose_headers;
	add_header Access-Control-Max-Age $cors_max_age;
	add_header Vary $cors_vary always;
	return 204;
}

# OPTIONS: with credentials
if ($cors_flags = '123') {
	add_header Access-Control-Allow-Origin $cors_allow_origin;
	add_header Access-Control-Allow-Methods $cors_allow_methods;
	add_header Access-Control-Allow-Headers $cors_allow_headers;
	add_header Access-Control-Expose-Headers $cors_allow_expose_headers;
	add_header Access-Control-Allow-Credentials 'true';
	add_header Access-Control-Max-Age $cors_max_age;
	add_header Vary $cors_vary always;
	return 204;
}